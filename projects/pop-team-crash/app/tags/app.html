<pop-app>
    <router>
        <route path="name">
            <pop-name/>
        </route>

        <route path="crash">
            <pop-crash/>
        </route>

        <!--redirect-->
        <route path="">
            <pop-name/>
        </route>
    </router>

    <script>
        this.on("mount", () => {
            window.addEventListener("orientationchange", this.handleRotateAlert);

            this.handleRotateAlert();
        });

        this.isLandscape = () => {
            const angle = screen.orientation.angle || window.orientation || 0;
            return Math.abs(angle) % 180 === 90;
        };

        this.handleRotateAlert = () => {
            if (this.isLandscape()) {
                swal({text: "横画面に対応していないクソアプリ"});
            } else {
                swal.close();
            }
        };

        (function () {
            var TWEET_PAGE_URL = "https://twitter.com/intent/tweet";
            var GAME_PAGE_URL = "";

            riot.mixin("links", {
                goTweetPage: function (text) {
                    location.href = `${TWEET_PAGE_URL}?hashtags=ポプテクラッシュ+%23そこんところ工房&text=${text}&url=${GAME_PAGE_URL}`;
                }
            });
        })();

        (function () {
            var LOCAL_STORAGE_KEY = "POP_TEAM_CRASH_STORAGE";
            var INITIAL_VALUES = {
                "sign_board_character": "竹◯某"
            };

            riot.mixin("storage", {
                init: function () {
                    if (!this._getItems()) {
                        localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(INITIAL_VALUES));
                    }
                },
                getSignBoardCharacter: function () {
                    return this._getItems()["sign_board_character"];
                },
                setSignBoardCharacter: function (char) {
                    const items = this._getItems();
                    items["sign_board_character"] = char;

                    this._setItems(items);
                },
                _getItems: function () {
                    return JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY));
                },
                _setItems: function (items) {
                    localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(items));
                }
            })
        })();

        (function () {
            firebase.initializeApp({
                "apiKey": "AIzaSyCifX-OuFPR0X-C8e-t4KaHdAO1Nkyx0dk",
                "databaseURL": "https://mini-projects-9e2c3.firebaseio.com",
                "storageBucket": "mini-projects-9e2c3.appspot.com",
                "authDomain": "mini-projects-9e2c3.firebaseapp.com",
                "messagingSenderId": "495662928019",
                "projectId": "mini-projects-9e2c3"
            });

            const auth = firebase.auth();
            const database = firebase.database();
            const observableFirebase = riot.observable();

            auth.onAuthStateChanged(function (user) {
                if (user) {
                    database.ref(`popTeamCrash/users/${user.uid}`).on("value", function (snapshot) {
                        observableFirebase.trigger("updateOwn", snapshot.val());
                    });

                    database.ref("popTeamCrash/total").on("value", function (snapshot) {
                        observableFirebase.trigger("updateTotal", snapshot.val());
                    });

                    observableFirebase.on("*", function (name, props) {
                        console.log(`on ${name}`, props);
                    });

                    observableFirebase.on("crash", function () {
                        const url = `https://us-central1-mini-projects-9e2c3.cloudfunctions.net/popTeamCrash/users/${user.uid}/crash`;
                        const xhr = new XMLHttpRequest();
                        xhr.open("PUT", url, true);
                        xhr.send();
                    });
                }
            });

            auth.signInAnonymously();

            riot.mixin("firebase", {
                onTotalUpdated: function (listener) {
                    observableFirebase.on("updateTotal", listener);
                },
                onOwnUpdated: function (listener) {
                    observableFirebase.on("updateOwn", listener);
                },
                sendCrashEvent: function () {
                    observableFirebase.trigger("crash");
                }
            })

        })();
    </script>

    <style>
        :scope {
            position: relative;
            display: block;
            background-color: rgba(0, 0, 0, 0.05);
            width: 100%;
            /* Aspect ratio of crash image. */
            padding-top: 68%;
        }
    </style>
</pop-app>
